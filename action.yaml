name: Push to GitHub repository
description: push files to github repository without cloning. the runner must contain curl and jq
inputs:
  branch:
    description: Git branch name, where changes should be pushed too. Required if Action is used on the `pull_request` event
    required: false
    default: ${{ github.head_ref }}
  commit_message:
    description: Commit message
    required: false
    default: Apply automatic changes
  repository:
    description: Local file path to the git repository. Defaults to the current directory (`.`)
    required: true
  commit_user_name:
    description: Name used for the commit user
    required: false
    default: github-actions[bot]
  commit_user_email:
    description: Email address used for the commit user
    required: false
    default: 41898283+github-actions[bot]@users.noreply.github.com
  github_token:
    description: The tocken authorized to write contents
    required: true
  files:
    description: 'json list with source and destination src1:dst1, .. srcN:dstN'
    required: true

  
outputs: {}
runs:
  using: composite
  steps:
  - name: push files
    env:
      GITHUB_TOKEN: ${{ inputs.github_token }}
    shell: bash
    run: |
      # upload files to repo
      set -ex
      FILES=$(echo '${{ inputs.files }}' | tr ',' ' ')
      for f in ${FILES} ; do
        SRC=${f%%:*}
        DST=${f##*:}
        echo "$src -> $dst"
        # get sha of existing file (if it exists)
        SHASUM=$(curl --location --silent --request GET \
          --header "Authorization: Bearer ${GITHUB_TOKEN}" \
          --header "Accept: application/vnd.github+json" \
          --header "X-GitHub-Api-Version: 2022-11-28" \
          https://api.github.com/repos/${{ inputs.repository }}/contents/${DST} | jq -r .sha)
        # create payload
        PAYLOAD=$(mktemp)
        jq -Rsc '{content: (. | @base64), message: "${{ inputs.commit_message }}", committer: {name: "${{ inputs.commit_user_name }}", email: "${{ inputs.commit_user_email }}", branch: "${{ inputs.branch }}"}, sha: "'${SHASUM}'" }' < "${SRC}" > ${PAYLOAD}
        cat ${PAYLOAD}
        rm -f ${PAYLOAD}
      done

